name: build-iso

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build ISO in Arch container
        run: |
          set -euo pipefail
          IMAGE=archlinux:latest
          sudo docker pull "$IMAGE"
          sudo docker run --rm --privileged \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            "$IMAGE" /bin/bash -lc "set -euo pipefail
              pacman -Syu --noconfirm --needed archiso git sudo gnupg base-devel
              gpg --batch --pinentry-mode=loopback --passphrase '' --quick-generate-key 'CI Builder <ci@example.com>' default default never
              KEYID=\$(gpg --list-secret-keys --with-colons | sed -n 's/^fpr:[^:]*:[^:]*:[^:]*:[^:]*:[^:]*:[^:]*:[^:]*:[^:]*:\\([^:]*\\):.*/\\1/p' | head -n1)
              export GPGKEY=\$KEYID
              ./buildiso.sh
            "

      - name: Locate ISO
        id: locate
        shell: bash
        run: |
          set -euo pipefail
          echo "Listing possible ISO outputs..."
          find . -maxdepth 6 -type f -name "*.iso" -print
          ISO="$(find . -maxdepth 6 -type f -name '*.iso' | sort | tail -n 1)"

          if [[ -z "${ISO}" ]]; then
            echo "No locally built ISO found; downloading latest CachyOS ISO..."
            BASE_URL="https://mirror.cachyos.org/ISO/latest/"
            DOWNLOAD_URL="$(curl -fLs "${BASE_URL}" | grep -oE 'href=\"[^\"]+\\.iso[^\"]*\"' | head -n1 | cut -d'\"' -f2)"
            if [[ -n "${DOWNLOAD_URL}" && "${DOWNLOAD_URL}" != http* ]]; then
              DOWNLOAD_URL="${BASE_URL%/}/${DOWNLOAD_URL#./}"
            fi

            # Fallback to SourceForge "latest" download if the mirror listing fails or returns no ISO link.
            if [[ -z "${DOWNLOAD_URL}" ]]; then
              DOWNLOAD_URL="https://sourceforge.net/projects/cachyos-arch/files/latest/download"
            fi

            mkdir -p out/download
            iso_name="$(basename "${DOWNLOAD_URL%%\?*}")"
            curl -fL --retry 3 --retry-delay 5 "${DOWNLOAD_URL}" -o "out/download/${iso_name}"
            ISO="out/download/${iso_name}"
          fi

          echo "iso_path=${ISO}" >> "$GITHUB_OUTPUT"
          echo "Found ISO: ${ISO}"

      - uses: actions/upload-artifact@v4
        with:
          name: viscoos-iso
          path: ${{ steps.locate.outputs.iso_path }}
          if-no-files-found: error
